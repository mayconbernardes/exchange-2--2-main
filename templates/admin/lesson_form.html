{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">{{ title }}</h1>
    <form id="lesson-form" method="POST" action="" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            {{ form.title.label(class="form-label") }}
            {{ form.title(class="form-control") }}
            {% if form.title.errors %}
            {% for error in form.title.errors %}
            <span class="text-danger">{{ error }}</span>
            {% endfor %}
            {% endif %}
        </div>
        <div class="mb-3">
            {{ form.text.label(class="form-label") }}
            <!-- Quill Editor Container -->
            <div id="editor-container"
                style="height: 300px; background: white; border: 1px solid #ced4da; border-radius: 0.375rem;">
                {{ form.text.data|safe if form.text.data else '' }}
            </div>
            <!-- Hidden textarea to store Quill HTML for POST -->
            {{ form.text(style="display:none; visibility:hidden;", id="lesson-text-input") }}
            {% if form.text.errors %}
            {% for error in form.text.errors %}
            <span class="text-danger">{{ error }}</span>
            {% endfor %}
            {% endif %}
        </div>
        <div class="mb-3">
            {{ form.audio.label(class="form-label") }}
            {{ form.audio(class="form-control") }}
            {% if form.audio.errors %}
            {% for error in form.audio.errors %}
            <span class="text-danger">{{ error }}</span>
            {% endfor %}
            {% endif %}
        </div>
        <div class="mb-3">
            {{ form.target_language.label(class="form-label") }}
            {{ form.target_language(class="form-control") }}
            {% if form.target_language.errors %}
            {% for error in form.target_language.errors %}
            <span class="text-danger">{{ error }}</span>
            {% endfor %}
            {% endif %}
        </div>
        <div class="mb-3">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>

<!-- Quill.js - Simple, Secure, and Free -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        placeholder: 'Escreva o conteúdo da lição aqui...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['link', 'clean']
            ]
        }
    });

    // Sync content on every change to ensure the hidden textarea is always updated
    quill.on('text-change', function () {
        var html = quill.root.innerHTML;
        // If the editor is empty, Quill might still have <p><br></p>. 
        // We handle empty state to satisfy DataRequired if needed.
        if (html === '<p><br></p>') html = '';
        document.getElementById('lesson-text-input').value = html;
    });

    // Populate the hidden input initially
    document.getElementById('lesson-text-input').value = quill.root.innerHTML;

    // Double check on form submit
    document.getElementById('lesson-form').onsubmit = function () {
        var html = quill.root.innerHTML;
        if (html === '<p><br></p>') html = '';
        document.getElementById('lesson-text-input').value = html;
        return true;
    };
</script>
{% endblock %}